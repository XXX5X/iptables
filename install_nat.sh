#!/bin/bash

# --- ASCII-–±–∞–Ω–Ω–µ—Ä (DenPiligrim) ---
echo "==================================================="
echo "    ____             ____  _ ___            _         "
echo "   / __ \___  ____  / __ \(_) (_)___ ______(_)___ ___ "
echo "  / / / / _ \/ __ \/ /_/ / / / / __ \/ ___/ / __ \`__ \ "
echo " / /_/ /  __/ / / / ____/ / / / /_/ / /  / / / / / / /"
echo "/_____/\___/_/ /_/_/   /_/_/_/\__, /_/  /_/_/ /_/ /_/ "
echo "                             /____/                   "
echo ""
echo "        IPTABLES DNAT/MASQUERADE INSTALLER         "
echo "==================================================="
echo ""
# --------------------

# –ó–∞–ø—Ä–æ—Å IP –∑–∞—Ä—É–±–µ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–µ–ª–æ–≤
# –ß–∏—Ç–∞–µ–º –≤–≤–æ–¥ —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ /dev/tty, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É —Å –ø–∞–π–ø–ª–∞–π–Ω–æ–º.
read -r -p "–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å –∑–∞—Ä—É–±–µ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞: " FOREIGN_IP_RAW < /dev/tty
FOREIGN_IP=$(echo "$FOREIGN_IP_RAW" | tr -d '[:space:]')
SERVER_IP=$(hostname -I | awk '{print $1}' | tr -d '[:space:]')

if [[ -z "$FOREIGN_IP" ]]; then
    echo "–û—à–∏–±–∫–∞: IP-–∞–¥—Ä–µ—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."
    exit 1
fi

# –ó–∞–ø—Ä–æ—Å –ø–æ—Ä—Ç–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–µ–ª–æ–≤
read -r -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–æ—Ä—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å: " PORT_RAW < /dev/tty
PORT=$(echo "$PORT_RAW" | tr -d '[:space:]')

# –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤–≤–µ–¥–µ–Ω–æ —á–∏—Å–ª–æ
if ! [[ "$PORT" =~ ^[0-9]+$ ]]; then
    echo "–û—à–∏–±–∫–∞: –ü–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º."
    exit 1
fi

# --- 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---
# –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
INTERFACE=$(ip route | grep default | awk '{print $5}' | head -n 1)

if [[ -z "$INTERFACE" ]]; then
    echo "–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å."
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: eth0, ens3, enp1s0. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π 'ip a'."
    # –ß–∏—Ç–∞–µ–º –≤–≤–æ–¥ —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ /dev/tty.
    read -r -p "–í–≤–µ–¥–∏—Ç–µ –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—Ä—É—á–Ω—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, eth0): " INTERFACE < /dev/tty
    if [[ -z "$INTERFACE" ]]; then
        echo "–û—à–∏–±–∫–∞: –°–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."
        exit 1
    fi
fi

echo ""
echo "‚öôÔ∏è –ò–°–ü–û–õ–¨–ó–£–ï–ú–´–ï –ü–ê–†–ê–ú–ï–¢–†–´:"
echo "–í–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: $INTERFACE"
echo "IP –∑–∞—Ä—É–±–µ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞: $FOREIGN_IP"
echo "–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º—ã–π –ø–æ—Ä—Ç (UDP): $PORT"
echo "-----------------------------------"
# –ß–∏—Ç–∞–µ–º –≤–≤–æ–¥ —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ /dev/tty.
read -r -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏..." < /dev/tty

# --- 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ iptables-persistent ---
echo ""
echo "–®–∞–≥ 1/5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ iptables-persistent..."
# –û–±–Ω–æ–≤–ª—è–µ–º
apt update
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ—Ç–≤–µ—Ç–æ–º "–î–∞" –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã (–µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ, -y)
# –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ iptables-persistent, –µ—Å–ª–∏ –æ–Ω —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –æ–Ω –Ω–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞—Ç—å.
# –ï—Å–ª–∏ –æ–Ω –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è, 
# –Ω–æ —ç—Ç–æ –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–± —Å–¥–µ–ª–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π.
apt install iptables-persistent -y
apt upgrade -y

# --- 4. –í–∫–ª—é—á–µ–Ω–∏–µ IPv4 —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞ ---
echo ""
echo "–®–∞–≥ 2/5: –í–∫–ª—é—á–µ–Ω–∏–µ IPv4 —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞..."
# –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—é –ø–∞–∫–µ—Ç–æ–≤.
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–º–µ–Ω—è–µ—Ç –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
if grep -q "^net.ipv4.ip_forward=1" /etc/sysctl.conf; then
    echo "net.ipv4.ip_forward=1 —É–∂–µ –≤–∫–ª—é—á–µ–Ω –≤ /etc/sysctl.conf."
elif grep -q "^#net.ipv4.ip_forward=1" /etc/sysctl.conf; then
    sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
    echo "–í–∫–ª—é—á–µ–Ω–æ net.ipv4.ip_forward=1 –≤ /etc/sysctl.conf."
else
    echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
    echo "–î–æ–±–∞–≤–ª–µ–Ω–æ net.ipv4.ip_forward=1 –≤ /etc/sysctl.conf."
fi

# –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
sysctl -p

# --- 5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª iptables ---
echo ""
echo "–®–∞–≥ 3/5: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª Iptables (DNAT –∏ MASQUERADE)..."

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∞–≤–∏–ª –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Ä—Ç–∞ (–¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ)
# –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
iptables -t nat -D PREROUTING -i "$INTERFACE" -p udp --dport "$PORT" -j DNAT --to-destination "$FOREIGN_IP":"$PORT" 2>/dev/null
iptables -t nat -D POSTROUTING -p udp -d "$FOREIGN_IP" --dport "$PORT" -j MASQUERADE 2>/dev/null

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ DNAT (Destination NAT)
# –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫, –ø—Ä–∏—Ö–æ–¥—è—â–∏–π –Ω–∞: –≤–∞—à-—Å–µ—Ä–≤–µ—Ä:$PORT -> $FOREIGN_IP:$PORT
iptables -t nat -A PREROUTING -i "$INTERFACE" -p udp --dport "$PORT" -j DNAT --to-destination "$FOREIGN_IP":"$PORT"
echo "–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ DNAT."

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ MASQUERADE (Source NAT)
# –ü–æ–¥–º–µ–Ω—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π IP-–∞–¥—Ä–µ—Å –Ω–∞ IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ –∑–∞—Ä—É–±–µ–∂–Ω—ã–π —Å–µ—Ä–≤–µ—Ä.
iptables -t nat -A POSTROUTING -p udp -d "$FOREIGN_IP" --dport "$PORT" -j MASQUERADE
echo "–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ MASQUERADE."

# --- 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å –ø–æ–º–æ—â—å—é iptables-persistent ---
echo ""
echo "–®–∞–≥ 4/5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –Ω–∞–≤—Å–µ–≥–¥–∞ (netfilter-persistent)..."
netfilter-persistent save
netfilter-persistent reload
echo "–ü—Ä–∞–≤–∏–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ /etc/iptables/rules.v4."

# --- 7. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–ª—É–∂–±—ã –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ ---
echo ""
echo "–®–∞–≥ 5/5: –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–ª—É–∂–±—ã systemd –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞..."

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å–ª—É–∂–±—ã
SERVICE_FILE="/etc/systemd/system/load-nat-rules.service"
cat << EOF > "$SERVICE_FILE"
[Unit]
Description=Load Custom NAT Rules After Network Up
After=network-online.target fail2ban.service netfilter-persistent.service
Wants=network-online.target

[Service]
Type=oneshot
# –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã —Å–µ—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–¥–Ω—è–ª–∞—Å—å
ExecStartPre=/bin/sleep 10
ExecStart=/bin/bash -c "/sbin/iptables-restore < /etc/iptables/rules.v4"
StandardOutput=journal

[Install]
WantedBy=multi-user.target
EOF
echo "–§–∞–π–ª —Å–ª—É–∂–±—ã '$SERVICE_FILE' —Å–æ–∑–¥–∞–Ω."

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ systemd –∏ –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
sudo systemctl daemon-reload
sudo systemctl enable load-nat-rules.service
echo "–°–ª—É–∂–±–∞ 'load-nat-rules.service' –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞."

# --- 8. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ ---
echo ""
echo "‚úÖ –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "–ü—Ä–∞–≤–∏–ª–∞ Iptables –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."
echo ""
echo "üî• –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ NAT:"
iptables -t nat -L -n -v

echo ""
echo "üö® –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–ª—É–∂–±–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç."
echo "–ö–æ–º–∞–Ω–¥–∞: 'sudo reboot'"
echo "–í –≤–∞—à–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ AWG –ø–æ–º–µ–Ω—è–π—Ç–µ IP –∞–¥—Ä–µ—Å –Ω–∞ $SERVER_IP"

exit 0