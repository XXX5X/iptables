# üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ –∫–∞—Å–∫–∞–¥–Ω–æ–º –í–ü–ù –¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ AmneziaWG UDP

## –û–±–∑–æ—Ä

–î–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É **DNAT** (Destination NAT) –∏ **MASQUERADE** (Source NAT) —Å –ø–æ–º–æ—â—å—é **iptables** –Ω–∞ –≤–∞—à–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ Ubuntu.

–≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è **–∫–∞—Å–∫–∞–¥–Ω—ã—Ö VPN-—Å—Ö–µ–º** (Proxy/NAT-—Å–µ—Ä–≤–µ—Ä–æ–≤), –∫–æ–≥–¥–∞ –≤—Ö–æ–¥—è—â–∏–π UDP-—Ç—Ä–∞—Ñ–∏–∫, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è **AmneziaWG** (–∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ VPN-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞), –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ **–∑–∞—Ä—É–±–µ–∂–Ω—ã–π —Å–µ—Ä–≤–µ—Ä**, –∞ –æ—Ç–≤–µ—Ç–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω (SNAT), —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Telegram-–∫–∞–Ω–∞–ª–µ: [https://t.me/denpiligrim\_web/699](https://t.me/denpiligrim_web/699)

---

## üõ† –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

* **–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:** Ubuntu 20.04 LTS (–∏ –≤—ã—à–µ).
* **–ü—Ä–∞–≤–∞:** –ù–µ–æ–±—Ö–æ–¥–∏–º –¥–æ—Å—Ç—É–ø —Å –ø—Ä–∞–≤–∞–º–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`sudo`).
* **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞:** –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (NAT-—Å–µ—Ä–≤–µ—Ä), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä.

---

## 1. –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏, –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª. –°–∫—Ä–∏–ø—Ç —Å–∞–º –∑–∞–ø—Ä–æ—Å–∏—Ç —É –≤–∞—Å **IP-–∞–¥—Ä–µ—Å –∑–∞—Ä—É–±–µ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞** –∏ **–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º—ã–π –ø–æ—Ä—Ç**.

```bash
wget -O - [https://raw.githubusercontent.com/–í–ê–®_–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨/–í–ê–®_–†–ï–ü–û–ó–ò–¢–û–†–ò–ô/main/install_nat.sh](https://raw.githubusercontent.com/–í–ê–®_–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨/–í–ê–®_–†–ï–ü–û–ó–ò–¢–û–†–ò–ô/main/install_nat.sh) | sudo bash
````

-----

## 2\. –ü–æ—à–∞–≥–æ–≤–∞—è —Ä—É—á–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

–ï—Å–ª–∏ –≤—ã –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å –∫–∞–∂–¥—ã–π —à–∞–≥, —Å–ª–µ–¥—É–π—Ç–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã–º –Ω–∏–∂–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º.

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–∫–µ—Ç `iptables-persistent` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install iptables-persistent -y 
# –í–æ –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–≤–∞–∂–¥—ã —Å–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª IPv4 –∏ IPv6.
```

### –®–∞–≥ 2: –í–∫–ª—é—á–µ–Ω–∏–µ IPv4 —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞

**DNAT** –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ–∫–∞ —è–¥—Ä–æ Linux –Ω–µ —Ä–∞–∑—Ä–µ—à–∏—Ç –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—é –ø–∞–∫–µ—Ç–æ–≤.

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `/etc/sysctl.conf` –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –æ–ø—Ü–∏—é:

```bash
sudo sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
sudo sysctl -p
```

### –®–∞–≥ 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–∞—à –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å. –û–Ω –±—É–¥–µ—Ç –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª–∞ **PREROUTING**.

```bash
ip a
```

–û–±—ã—á–Ω–æ —ç—Ç–æ: `eth0`, `ens3`, `ens160`, –∏–ª–∏ `enp1s0`. –î–æ–ø—É—Å—Ç–∏–º, –≤–∞—à –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî **`eth0`**.

### –®–∞–≥ 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª Iptables

–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ:

  * **–í–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:** `eth0`
  * **–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º—ã–π –ø–æ—Ä—Ç (UDP):** `34666`
  * **IP –∑–∞—Ä—É–±–µ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:** `37.1.204.148`

#### 4.1. DNAT (Destination NAT)

–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ —Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä:

```bash
sudo iptables -t nat -A PREROUTING -i eth0 -p udp --dport 34666 -j DNAT --to-destination 37.1.204.148:34666
```

#### 4.2. MASQUERADE (SNAT)

**–í–∞–∂–Ω–æ\!** –ü–æ–¥–º–µ–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π IP-–∞–¥—Ä–µ—Å –Ω–∞ IP –≤–∞—à–µ–≥–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∑–∞—Ä—É–±–µ–∂–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤–∞—à–µ–º—É –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É, –∞ –Ω–µ –Ω–∞–ø—Ä—è–º—É—é –∫–ª–∏–µ–Ω—Ç—É.

```bash
sudo iptables -t nat -A POSTROUTING -p udp -d 37.1.204.148 --dport 34666 -j MASQUERADE
```

### –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –Ω–∞–≤—Å–µ–≥–¥–∞

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Å –ø–æ–º–æ—â—å—é `iptables-persistent`:

```bash
sudo netfilter-persistent save
sudo netfilter-persistent reload
```

### –®–∞–≥ 6: –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É–∂–±—ã –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ (Systemd)

–ß—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –ø—Ä–∞–≤–∏–ª–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—Å—è —Å–µ—Ä–≤–∏—Å `netfilter-persistent`, —Å–æ–∑–¥–∞–π—Ç–µ —Å–ª—É–∂–±—É **Systemd**, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å—Ç–∏—Ç –∏—Ö —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø–æ–¥–Ω—è—Ç–∏—è —Å–µ—Ç–∏.

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª —Å–ª—É–∂–±—ã:

```bash
sudo nano /etc/systemd/system/load-nat-rules.service
```

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:

```ini
[Unit]
Description=Load Custom NAT Rules After Network Up
After=network-online.target fail2ban.service netfilter-persistent.service
Wants=network-online.target

[Service]
Type=oneshot
ExecStartPre=/bin/sleep 10
ExecStart=/bin/bash -c "/sbin/iptables-restore < /etc/iptables/rules.v4"
StandardOutput=journal

[Install]
WantedBy=multi-user.target
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥ Systemd –∏ –≤–∫–ª—é—á–∏—Ç–µ —Å–ª—É–∂–±—É:

```bash
sudo systemctl daemon-reload
sudo systemctl enable load-nat-rules.service
```

### –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∞–≤–∏–ª–∞ –±—ã–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:

```bash
sudo iptables -t nat -L -n -v
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–∞–≤–∏–ª–∞ **DNAT** –∏ **MASQUERADE** –≤ —Ç–∞–±–ª–∏—Ü–µ NAT.

–î–ª—è –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ **—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä**:

```bash
sudo reboot
```
```
```